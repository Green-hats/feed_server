<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>喂饭机器人后台管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --light-gray: #e9ecef;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
        }

        /* 顶部导航 */
        .navbar {
            background: var(--secondary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* 主容器 */
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* 卡片样式 */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary);
        }

        .card-body {
            padding: 20px;
        }

        /* 仪表盘统计卡片 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .stat-icon.blue {
            background: rgba(52, 152, 219, 0.2);
            color: var(--primary);
        }

        .stat-icon.green {
            background: rgba(46, 204, 113, 0.2);
            color: var(--success);
        }

        .stat-icon.orange {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning);
        }

        .stat-icon.red {
            background: rgba(231, 76, 60, 0.2);
            color: var(--danger);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* 表格样式 */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }

        th {
            background-color: var(--light);
            font-weight: 600;
        }

        tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn i {
            font-size: 0.9rem;
        }

        /* 操作按钮 */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 0.85rem;
        }

        /* 标签页样式 */
        .tabs {
            display: flex;
            border-bottom: 2px solid #3498db;
            margin-bottom: 20px;
        }

        .tab {
            background-color: #f1f1f1;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 20px;
            transition: 0.3s;
            font-size: 17px;
        }

        .tab:hover {
            background-color: #ddd;
        }

        .tab.active {
            background-color: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background-color: white;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--light-gray);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>
</head>

<body>
    <!-- 顶部导航 -->
    <nav class="navbar">
        <div class="navbar-brand">
            <i class="fas fa-robot"></i>
            <span>喂饭机器人后台管理系统</span>
        </div>
        <div class="navbar-user">
            <div class="user-avatar">A</div>
            <span>管理员</span>
        </div>
    </nav>

    <!-- 主内容区 -->
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="openTab('dashboard')">仪表盘</button>
            <button class="tab" onclick="openTab('persons')">人员管理</button>
            <button class="tab" onclick="openTab('foods')">食物管理</button>
            <button class="tab" onclick="openTab('locations')">地点管理</button>
            <button class="tab" onclick="openTab('feedings')">喂食记录</button>
            <button class="tab" onclick="openTab('ratings')">满意度管理</button>
        </div>

        <!-- 仪表盘页面 -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="stat-value" id="total-records">0</div>
                    <div class="stat-label">总喂食记录</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon green">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="stat-value" id="today-records">0</div>
                    <div class="stat-label">今日喂食记录</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon orange">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-value" id="avg-rating">0.0</div>
                    <div class="stat-label">平均满意度</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon red">
                        <i class="fas fa-utensils"></i>
                    </div>
                    <div class="stat-value" id="popular-food">-</div>
                    <div class="stat-label">最受欢迎食物</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">最近喂食记录</div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>人员</th>
                                    <th>食物</th>
                                    <th>地点</th>
                                    <th>份量(g)</th>
                                    <th>评分</th>
                                </tr>
                            </thead>
                            <tbody id="recent-feedings">
                                <!-- 动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 人员管理页面 -->
        <div id="persons" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">人员管理</div>
                    <button class="btn btn-primary" onclick="openPersonModal()">
                        <i class="fas fa-plus"></i> 添加人员
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>姓名</th>
                                    <th>年龄</th>
                                    <th>饮食需求</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="persons-list">
                                <!-- 动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 食物管理页面 -->
        <div id="foods" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">食物管理</div>
                    <button class="btn btn-primary" onclick="openFoodModal()">
                        <i class="fas fa-plus"></i> 添加食物
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>名称</th>
                                    <th>类别</th>
                                    <th>热量(卡/100g)</th>
                                    <th>描述</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="foods-list">
                                <!-- 动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 地点管理页面 -->
        <div id="locations" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">地点管理</div>
                    <button class="btn btn-primary" onclick="openLocationModal()">
                        <i class="fas fa-plus"></i> 添加地点
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>名称</th>
                                    <th>描述</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="locations-list">
                                <!-- 动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 喂食记录页面 -->
        <div id="feedings" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">喂食记录</div>
                    <button class="btn btn-primary" onclick="openFeedingModal()">
                        <i class="fas fa-plus"></i> 添加记录
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>时间</th>
                                    <th>人员</th>
                                    <th>食物</th>
                                    <th>地点</th>
                                    <th>份量(g)</th>
                                    <th>备注</th>
                                    <th>评分</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="feedings-list">
                                <!-- 动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 满意度管理页面 -->
        <div id="ratings" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">满意度管理</div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>记录ID</th>
                                    <th>时间</th>
                                    <th>人员</th>
                                    <th>食物</th>
                                    <th>评分</th>
                                    <th>评语</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="ratings-list">
                                <!-- 动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 人员模态框 -->
    <div class="modal" id="person-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="person-modal-title">添加人员</h3>
                <button class="modal-close" onclick="closeModal('person-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="person-form">
                    <input type="hidden" id="person-id">
                    <div class="form-group">
                        <label for="person-name">姓名 *</label>
                        <input type="text" id="person-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="person-age">年龄</label>
                        <input type="number" id="person-age" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="person-dietary">饮食需求</label>
                        <textarea id="person-dietary" class="form-control"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('person-modal')">取消</button>
                <button class="btn btn-primary" onclick="savePerson()">保存</button>
            </div>
        </div>
    </div>

    <!-- 食物模态框 -->
    <div class="modal" id="food-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="food-modal-title">添加食物</h3>
                <button class="modal-close" onclick="closeModal('food-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="food-form">
                    <input type="hidden" id="food-id">
                    <div class="form-group">
                        <label for="food-name">名称 *</label>
                        <input type="text" id="food-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="food-category">类别</label>
                        <input type="text" id="food-category" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="food-calories">热量(卡/100g)</label>
                        <input type="number" id="food-calories" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="food-description">描述</label>
                        <textarea id="food-description" class="form-control"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('food-modal')">取消</button>
                <button class="btn btn-primary" onclick="saveFood()">保存</button>
            </div>
        </div>
    </div>

    <!-- 地点模态框 -->
    <div class="modal" id="location-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="location-modal-title">添加地点</h3>
                <button class="modal-close" onclick="closeModal('location-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="location-form">
                    <input type="hidden" id="location-id">
                    <div class="form-group">
                        <label for="location-name">名称 *</label>
                        <input type="text" id="location-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="location-description">描述</label>
                        <textarea id="location-description" class="form-control"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('location-modal')">取消</button>
                <button class="btn btn-primary" onclick="saveLocation()">保存</button>
            </div>
        </div>
    </div>

    <!-- 喂食记录模态框 -->
    <div class="modal" id="feeding-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="feeding-modal-title">添加喂食记录</h3>
                <button class="modal-close" onclick="closeModal('feeding-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="feeding-form">
                    <input type="hidden" id="feeding-id">
                    <div class="form-group">
                        <label for="feeding-person">人员 *</label>
                        <select id="feeding-person" class="form-control" required></select>
                    </div>
                    <div class="form-group">
                        <label for="feeding-food">食物 *</label>
                        <select id="feeding-food" class="form-control" required></select>
                    </div>
                    <div class="form-group">
                        <label for="feeding-location">地点 *</label>
                        <select id="feeding-location" class="form-control" required></select>
                    </div>
                    <div class="form-group">
                        <label for="feeding-portion">份量(g)</label>
                        <input type="number" id="feeding-portion" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="feeding-notes">备注</label>
                        <textarea id="feeding-notes" class="form-control"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('feeding-modal')">取消</button>
                <button class="btn btn-primary" onclick="saveFeeding()">保存</button>
            </div>
        </div>
    </div>

    <!-- 满意度模态框 -->
    <div class="modal" id="rating-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="rating-modal-title">添加满意度评分</h3>
                <button class="modal-close" onclick="closeModal('rating-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="rating-form">
                    <input type="hidden" id="rating-record-id">
                    <div class="form-group">
                        <label for="rating-score">评分 *</label>
                        <div class="rating-stars">
                            <span onclick="setRating(1)">☆</span>
                            <span onclick="setRating(2)">☆</span>
                            <span onclick="setRating(3)">☆</span>
                            <span onclick="setRating(4)">☆</span>
                            <span onclick="setRating(5)">☆</span>
                        </div>
                        <input type="hidden" id="rating-score" required>
                    </div>
                    <div class="form-group">
                        <label for="rating-comment">评语</label>
                        <textarea id="rating-comment" class="form-control"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('rating-modal')">取消</button>
                <button class="btn btn-primary" onclick="saveRating()">保存</button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let persons = [];
        let foods = [];
        let locations = [];
        let feedings = [];
        let ratings = [];

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            // 加载初始数据
            loadDashboardData();
            loadPersons();
            loadFoods();
            loadLocations();
            loadFeedings();
            loadRatings();
        });

        // 切换标签页
        function openTab(tabName) {
            // 隐藏所有标签内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // 移除所有标签的活动状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // 显示选中的标签内容
            document.getElementById(tabName).classList.add('active');

            // 设置选中的标签为活动状态
            event.currentTarget.classList.add('active');

            // 如果是历史页，刷新数据
            if (tabName === 'dashboard') {
                loadDashboardData();
            }
        }

        // 加载仪表盘数据
        async function loadDashboardData() {
            try {
                // 获取统计数据
                const statsResponse = await fetch('/api/stats');
                const stats = await statsResponse.json();

                // 更新统计卡片
                document.getElementById('total-records').textContent = stats.total_records;
                document.getElementById('today-records').textContent = stats.today_records;
                document.getElementById('avg-rating').textContent = stats.avg_rating;
                document.getElementById('popular-food').textContent = stats.popular_food;

                // 获取最近喂食记录
                const feedingsResponse = await fetch('/api/feedings');
                const recentFeedings = await feedingsResponse.json();

                // 显示最近5条记录
                updateRecentFeedingsTable(recentFeedings.slice(0, 5));
            } catch (err) {
                console.error('加载仪表盘数据失败:', err);
                alert('加载数据失败: ' + err.message);
            }
        }

        // 更新最近喂食记录表格
        function updateRecentFeedingsTable(feedings) {
            const tbody = document.getElementById('recent-feedings');
            tbody.innerHTML = '';

            if (feedings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">没有喂食记录</td></tr>';
                return;
            }

            feedings.forEach(feed => {
                const row = document.createElement('tr');

                // 格式化日期
                const date = new Date(feed.feeding_time);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

                // 评分显示
                let ratingDisplay = '未评分';
                if (feed.score) {
                    ratingDisplay = '★'.repeat(feed.score) + '☆'.repeat(5 - feed.score);
                }

                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${feed.person_name}</td>
                    <td>${feed.food_name}</td>
                    <td>${feed.location_name}</td>
                    <td>${feed.portion_size || '-'}</td>
                    <td>${ratingDisplay}</td>
                `;

                tbody.appendChild(row);
            });
        }

        // 加载人员数据
        async function loadPersons() {
            try {
                const response = await fetch('/api/persons');
                persons = await response.json();
                updatePersonsTable();
            } catch (err) {
                console.error('加载人员数据失败:', err);
                alert('加载人员数据失败: ' + err.message);
            }
        }

        // 更新人员表格
        function updatePersonsTable() {
            const tbody = document.getElementById('persons-list');
            tbody.innerHTML = '';

            if (persons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">没有人员数据</td></tr>';
                return;
            }

            persons.forEach(person => {
                const row = document.createElement('tr');

                // 格式化日期
                const date = new Date(person.created_at);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;

                row.innerHTML = `
                    <td>${person.person_id}</td>
                    <td>${person.name}</td>
                    <td>${person.age || '-'}</td>
                    <td>${person.dietary_needs || '无'}</td>
                    <td>${formattedDate}</td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editPerson(${person.person_id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deletePerson(${person.person_id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // 打开人员模态框
        function openPersonModal(personId = null) {
            const modal = document.getElementById('person-modal');
            const title = document.getElementById('person-modal-title');

            if (personId) {
                // 编辑模式
                title.textContent = '编辑人员';
                const person = persons.find(p => p.person_id == personId);
                if (person) {
                    document.getElementById('person-id').value = person.person_id;
                    document.getElementById('person-name').value = person.name;
                    document.getElementById('person-age').value = person.age || '';
                    document.getElementById('person-dietary').value = person.dietary_needs || '';
                }
            } else {
                // 添加模式
                title.textContent = '添加人员';
                document.getElementById('person-form').reset();
            }

            modal.classList.add('show');
        }

        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // 保存人员
        async function savePerson() {
            const personId = document.getElementById('person-id').value;
            const name = document.getElementById('person-name').value;
            const age = document.getElementById('person-age').value;
            const dietary = document.getElementById('person-dietary').value;

            if (!name) {
                alert('姓名不能为空');
                return;
            }

            try {
                let response;
                if (personId) {
                    // 更新人员
                    response = await fetch(`/api/persons/${personId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, age, dietary_needs: dietary })
                    });
                } else {
                    // 添加人员
                    response = await fetch('/api/persons', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, age, dietary_needs: dietary })
                    });
                }

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    closeModal('person-modal');
                    loadPersons();
                } else {
                    throw new Error(result.error || '未知错误');
                }
            } catch (err) {
                console.error('保存人员失败:', err);
                alert('保存失败: ' + err.message);
            }
        }

        // 删除人员
        async function deletePerson(personId) {
            if (!confirm('确定要删除此人员吗？')) return;

            try {
                const response = await fetch(`/api/persons/${personId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    loadPersons();
                } else {
                    throw new Error(result.error || '未知错误');
                }
            } catch (err) {
                console.error('删除人员失败:', err);
                alert('删除失败: ' + err.message);
            }
        }

        // 编辑人员
        function editPerson(personId) {
            openPersonModal(personId);
        }

        // 加载食物数据
        async function loadFoods() {
            try {
                const response = await fetch('/api/foods');
                foods = await response.json();
                updateFoodsTable();
            } catch (err) {
                console.error('加载食物数据失败:', err);
                alert('加载食物数据失败: ' + err.message);
            }
        }

        // 更新食物表格
        function updateFoodsTable() {
            const tbody = document.getElementById('foods-list');
            tbody.innerHTML = '';

            if (foods.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">没有食物数据</td></tr>';
                return;
            }

            foods.forEach(food => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${food.food_id}</td>
                    <td>${food.name}</td>
                    <td>${food.category || '-'}</td>
                    <td>${food.calories || '-'}</td>
                    <td>${food.description || '无'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editFood(${food.food_id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteFood(${food.food_id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 打开食物模态框
        function openFoodModal(foodId = null) {
            const modal = document.getElementById('food-modal');
            const title = document.getElementById('food-modal-title');

            if (foodId) {
                // 编辑模式
                title.textContent = '编辑食物';
                const food = foods.find(f => f.food_id == foodId);
                if (food) {
                    document.getElementById('food-id').value = food.food_id;
                    document.getElementById('food-name').value = food.name;
                    document.getElementById('food-category').value = food.category || '';
                    document.getElementById('food-calories').value = food.calories || '';
                    document.getElementById('food-description').value = food.description || '';
                }
            } else {
                // 添加模式
                title.textContent = '添加食物';
                document.getElementById('food-form').reset();
            }

            modal.classList.add('show');
        }

        // 保存食物
        async function saveFood() {
            const foodId = document.getElementById('food-id').value;
            const name = document.getElementById('food-name').value;
            const category = document.getElementById('food-category').value;
            const calories = document.getElementById('food-calories').value;
            const description = document.getElementById('food-description').value;

            if (!name) {
                alert('食物名称不能为空');
                return;
            }

            try {
                let response;
                if (foodId) {
                    // 更新食物
                    response = await fetch(`/api/foods/${foodId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, category, calories, description })
                    });
                } else {
                    // 添加食物
                    response = await fetch('/api/foods', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, category, calories, description })
                    });
                }

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    closeModal('food-modal');
                    loadFoods();
                } else {
                    throw new Error(result.error || '未知错误');
                }
            } catch (err) {
                console.error('保存食物失败:', err);
                alert('保存失败: ' + err.message);
            }
        }

        // 删除食物
        async function deleteFood(foodId) {
            if (!confirm('确定要删除此食物吗？')) return;

            try {
                const response = await fetch(`/api/foods/${foodId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    loadFoods();
                } else {
                    throw new Error(result.error || '未知错误');
                }
            } catch (err) {
                console.error('删除食物失败:', err);
                alert('删除失败: ' + err.message);
            }
        }

        // 编辑食物
        function editFood(foodId) {
            openFoodModal(foodId);
        }

        // 加载地点数据
        async function loadLocations() {
            try {
                const response = await fetch('/api/locations');
                locations = await response.json();
                updateLocationsTable();
            } catch (err) {
                console.error('加载地点数据失败:', err);
                alert('加载地点数据失败: ' + err.message);
            }
        }

        // 更新地点表格
        function updateLocationsTable() {
            const tbody = document.getElementById('locations-list');
            tbody.innerHTML = '';

            if (locations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">没有地点数据</td></tr>';
                return;
            }

            locations.forEach(location => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${location.location_id}</td>
                    <td>${location.name}</td>
                    <td>${location.description || '无'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editLocation(${location.location_id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteLocation(${location.location_id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 打开地点模态框
        function openLocationModal(locationId = null) {
            const modal = document.getElementById('location-modal');
            const title = document.getElementById('location-modal-title');

            if (locationId) {
                // 编辑模式
                title.textContent = '编辑地点';
                const location = locations.find(l => l.location_id == locationId);
                if (location) {
                    document.getElementById('location-id').value = location.location_id;
                    document.getElementById('location-name').value = location.name;
                    document.getElementById('location-description').value = location.description || '';
                }
            } else {
                // 添加模式
                title.textContent = '添加地点';
                document.getElementById('location-form').reset();
            }

            modal.classList.add('show');
        }

        // 保存地点
        async function saveLocation() {
            const locationId = document.getElementById('location-id').value;
            const name = document.getElementById('location-name').value;
            const description = document.getElementById('location-description').value;

            if (!name) {
                alert('地点名称不能为空');
                return;
            }

            try {
                let response;
                if (locationId) {
                    // 更新地点
                    response = await fetch(`/api/locations/${locationId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description })
                    });
                } else {
                    // 添加地点
                    response = await fetch('/api/locations', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description })
                    });
                }

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    closeModal('location-modal');
                    loadLocations();
                } else {
                    throw new Error(result.error || '未知错误');
                }
            } catch (err) {
                console.error('保存地点失败:', err);
                alert('保存失败: ' + err.message);
            }
        }

        // 删除地点
        async function deleteLocation(locationId) {
            if (!confirm('确定要删除此地点吗？')) return;

            try {
                const response = await fetch(`/api/locations/${locationId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    loadLocations();
                } else {
                    throw new Error(result.error || '未知错误');
                }
            } catch (err) {
                console.error('删除地点失败:', err);
                alert('删除失败: ' + err.message);
            }
        }

        // 编辑地点
        function editLocation(locationId) {
            openLocationModal(locationId);
        }

        // 加载喂食记录
        async function loadFeedings() {
            try {
                const response = await fetch('/api/feedings');
                feedings = await response.json();
                updateFeedingsTable();
            } catch (err) {
                console.error('加载喂食记录失败:', err);
                alert('加载喂食记录失败: ' + err.message);
            }
        }

        // 更新喂食记录表格
        function updateFeedingsTable() {
            const tbody = document.getElementById('feedings-list');
            tbody.innerHTML = '';

            if (feedings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9">没有喂食记录</td></tr>';
                return;
            }

            feedings.forEach(feed => {
                const row = document.createElement('tr');

                // 格式化日期
                const date = new Date(feed.feeding_time);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

                // 评分显示
                let ratingDisplay = '未评分';
                if (feed.score) {
                    ratingDisplay = '★'.repeat(feed.score) + '☆'.repeat(5 - feed.score);
                    if (feed.satisfaction) {
                        ratingDisplay += `<br><small>${feed.satisfaction}</small>`;
                    }
                }

                row.innerHTML = `
                    <td>${feed.record_id}</td>
                    <td>${formattedDate}</td>
                    <td>${feed.person_name}</td>
                    <td>${feed.food_name}</td>
                    <td>${feed.location_name}</td>
                    <td>${feed.portion_size || '-'}</td>
                    <td>${feed.notes || '无'}</td>
                    <td>${ratingDisplay}</td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editFeeding(${feed.record_id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteFeeding(${feed.record_id})">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-success btn-sm" onclick="openRatingModal(${feed.record_id})">
                            <i class="fas fa-star"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 打开喂食记录模态框
        function openFeedingModal(recordId = null) {
            const modal = document.getElementById('feeding-modal');
            const title = document.getElementById('feeding-modal-title');

            // 填充下拉框
            populateDropdown('feeding-person', persons, 'person_id', 'name');
            populateDropdown('feeding-food', foods, 'food_id', 'name');
            populateDropdown('feeding-location', locations, 'location_id', 'name');

            if (recordId) {
                // 编辑模式
                title.textContent = '编辑喂食记录';
                const feeding = feedings.find(f => f.record_id == recordId);
                if (feeding) {
                    document.getElementById('feeding-id').value = feeding.record_id;
                    document.getElementById('feeding-person').value = feeding.person_id;
                    document.getElementById('feeding-food').value = feeding.food_id;
                    document.getElementById('feeding-location').value = feeding.location_id;
                    document.getElementById('feeding-portion').value = feeding.portion_size || '';
                    document.getElementById('feeding-notes').value = feeding.notes || '';
                }
            } else {
                // 添加模式
                title.textContent = '添加喂食记录';
                document.getElementById('feeding-form').reset();
            }

            modal.classList.add('show');
        }

        // 填充下拉框
        function populateDropdown(elementId, items, valueKey, textKey) {
            const select = document.getElementById(elementId);
            select.innerHTML = '';

            // 添加默认选项
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = `请选择${elementId.includes('person') ? '人员' : elementId.includes('food') ? '食物' : '地点'}`;
            defaultOption.disabled = true;
            defaultOption.selected = true;
            select.appendChild(defaultOption);

            // 添加选项
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueKey];
                option.textContent = item[textKey];
                select.appendChild(option);
            });
        }

        // 保存喂食记录
        async function saveFeeding() {
            const recordId = document.getElementById('feeding-id').value;
            const personId = document.getElementById('feeding-person').value;
            const foodId = document.getElementById('feeding-food').value;
            const locationId = document.getElementById('feeding-location').value;
            const portion = document.getElementById('feeding-portion').value;
            const notes = document.getElementById('feeding-notes').value;

            if (!personId || !foodId || !locationId) {
                alert('请选择人员、食物和地点');
                return;
            }

            try {
                let response;
                if (recordId) {
                    // 更新记录
                    response = await fetch(`/api/feedings/${recordId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            person_id: personId,
                            food_id: foodId,
                            location_id: locationId,
                            portion_size: portion,
                            notes: notes
                        })
                    });
                } else {
                    // 添加记录
                    response = await fetch('/api/feedings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            person_id: personId,
                            food_id: foodId,
                            location_id: locationId,
                            portion_size: portion,
                            notes: notes
                        })
                    });
                }

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    closeModal('feeding-modal');
                    loadFeedings();
                } else {
                    throw new Error(result.error || '未知错误');
                }
            } catch (err) {
                console.error('保存喂食记录失败:', err);
                alert('保存失败: ' + err.message);
            }
        }

        // 删除喂食记录
        async function deleteFeeding(recordId) {
            if (!confirm('确定要删除此喂食记录吗？')) return;

            try {
                const response = await fetch(`/api/feedings/${recordId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    loadFeedings();
                } else {
                    throw new Error(result.error || '未知错误');
                }
            } catch (err) {
                console.error('删除喂食记录失败:', err);
                alert('删除失败: ' + err.message);
            }
        }

        // 编辑喂食记录
        function editFeeding(recordId) {
            openFeedingModal(recordId);
        }

        // 加载满意度数据
        async function loadRatings() {
            try {
                const response = await fetch('/api/feedings');
                ratings = await response.json();
                updateRatingsTable();
            } catch (err) {
                console.error('加载满意度数据失败:', err);
                alert('加载满意度数据失败: ' + err.message);
            }
        }

        // 更新满意度表格
        function updateRatingsTable() {
            const tbody = document.getElementById('ratings-list');
            tbody.innerHTML = '';

            // 过滤出有评分的记录
            const ratedFeedings = ratings.filter(feed => feed.score);

            if (ratedFeedings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">没有满意度数据</td></tr>';
                return;
            }

            ratedFeedings.forEach(feed => {
                const row = document.createElement('tr');

                // 格式化日期
                const date = new Date(feed.feeding_time);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

                row.innerHTML = `
                    <td>${feed.record_id}</td>
                    <td>${formattedDate}</td>
                    <td>${feed.person_name}</td>
                    <td>${feed.food_name}</td>
                    <td>${'★'.repeat(feed.score) + '☆'.repeat(5 - feed.score)}</td>
                    <td>${feed.satisfaction || '无'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-sm" onclick="editRating(${feed.record_id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteRating(${feed.record_id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 打开评分模态框
        function openRatingModal(recordId) {
            const modal = document.getElementById('rating-modal');
            const title = document.getElementById('rating-modal-title');

            title.textContent = '添加满意度评分';
            document.getElementById('rating-record-id').value = recordId;
            document.getElementById('rating-form').reset();
            setRating(0);

            modal.classList.add('show');
        }

        // 设置评分
        function setRating(score) {
            document.getElementById('rating-score').value = score;
            const stars = document.querySelectorAll('#rating-modal .rating-stars span');
            stars.forEach((star, index) => {
                star.textContent = index < score ? '★' : '☆';
            });
        }

        // 保存评分
        async function saveRating() {
            const recordId = document.getElementById('rating-record-id').value;
            const score = document.getElementById('rating-score').value;
            const comment = document.getElementById('rating-comment').value;

            if (!score || score < 1) {
                alert('请选择评分');
                return;
            }

            try {
                const response = await fetch(`/api/ratings/${recordId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ score, comment })
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    closeModal('rating-modal');
                    loadFeedings();
                    loadRatings();
                } else {
                    throw new Error(result.error || '未知错误');
                }
            } catch (err) {
                console.error('添加评分失败:', err);
                alert('添加评分失败: ' + err.message);
            }
        }

        // 删除评分
        async function deleteRating(recordId) {
            if (!confirm('确定要删除此评分吗？')) return;

            try {
                const response = await fetch(`/api/ratings/${recordId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    loadFeedings();
                    loadRatings();
                } else {
                    throw new Error(result.error || '未知错误');
                }
            } catch (err) {
                console.error('删除评分失败:', err);
                alert('删除失败: ' + err.message);
            }
        }

        // 编辑评分
        function editRating(recordId) {
            const modal = document.getElementById('rating-modal');
            const title = document.getElementById('rating-modal-title');
            const feeding = feedings.find(f => f.record_id == recordId);

            if (feeding) {
                title.textContent = '编辑满意度评分';
                document.getElementById('rating-record-id').value = recordId;
                setRating(feeding.score || 0);
                document.getElementById('rating-comment').value = feeding.satisfaction || '';
                modal.classList.add('show');
            }
        }
    </script>
</body>

</html>